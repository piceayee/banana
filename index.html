// 試算工具 - 年化保費與欄位優化

import { useState } from 'react';

export default function InsuranceCalculator() {
  const [totalTyphoons, setTotalTyphoons] = useState('');
  const [years, setYears] = useState('');
  const [sumInsured, setSumInsured] = useState('');
  const [frequencies, setFrequencies] = useState(Array(12).fill(''));
  const [payoutRates, setPayoutRates] = useState(Array(12).fill(''));

  const handleFrequencyChange = (index, value) => {
    const newFreqs = [...frequencies];
    newFreqs[index] = value;
    setFrequencies(newFreqs);
  };

  const handlePayoutRateChange = (index, value) => {
    const newRates = [...payoutRates];
    newRates[index] = value;
    setPayoutRates(newRates);
  };

  const calculate = () => {
    const total = parseFloat(totalTyphoons) || 0;
    const yearCount = parseFloat(years) || 1;
    const insured = parseFloat(sumInsured) || 0;
    const avgTyphoonPerYear = total / yearCount;

    let expectedLossPerTyphoon = 0;
    for (let i = 0; i < frequencies.length; i++) {
      const freq = parseFloat(frequencies[i]) || 0;
      const rate = parseFloat(payoutRates[i]) || 0;
      const payout = (insured * rate) / 100;
      expectedLossPerTyphoon += (freq / total) * payout;
    }

    const annualPurePremium = avgTyphoonPerYear * expectedLossPerTyphoon;

    return {
      avgTyphoonPerYear,
      expectedLossPerTyphoon,
      annualPurePremium,
    };
  };

  const result = calculate();

  return (
    <div className="p-4 max-w-4xl mx-auto">
      <h1 className="text-2xl font-bold mb-4">香蕉氣象參數型保險試算工具</h1>

      <div className="grid grid-cols-2 gap-4 mb-4">
        <label>
          歷史颱風總次數：
          <input
            type="number"
            value={totalTyphoons}
            onChange={(e) => setTotalTyphoons(e.target.value)}
            className="border p-2 w-full"
          />
        </label>
        <label>
          歷史年份數：
          <input
            type="number"
            value={years}
            onChange={(e) => setYears(e.target.value)}
            className="border p-2 w-full"
          />
        </label>
        <label>
          保險金額（元）：
          <input
            type="number"
            value={sumInsured}
            onChange={(e) => setSumInsured(e.target.value)}
            className="border p-2 w-full"
          />
        </label>
      </div>

      <div className="overflow-x-auto">
        <table className="table-auto w-full border">
          <thead>
            <tr>
              <th className="border px-2">級風</th>
              <th className="border px-2">賠付比例 (%)</th>
              <th className="border px-2">該級風出現次數</th>
            </tr>
          </thead>
          <tbody>
            {Array.from({ length: 12 }).map((_, i) => (
              <tr key={i}>
                <td className="border px-2 text-center">{i + 7}</td>
                <td className="border px-2">
                  <input
                    type="number"
                    value={payoutRates[i]}
                    onChange={(e) => handlePayoutRateChange(i, e.target.value)}
                    className="w-full p-1 border"
                    placeholder="%"
                  />
                </td>
                <td className="border px-2">
                  <input
                    type="number"
                    value={frequencies[i]}
                    onChange={(e) => handleFrequencyChange(i, e.target.value)}
                    className="w-full p-1 border"
                    placeholder="次數"
                  />
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <div className="mt-4 p-4 border rounded bg-gray-50">
        <p>➤ 年均颱風數：{result.avgTyphoonPerYear.toFixed(2)}</p>
        <p>➤ 每次颱風平均損失：{result.expectedLossPerTyphoon.toFixed(0)} 元</p>
        <p className="font-bold text-red-600">
          ➤ 年純保費：{result.annualPurePremium.toFixed(0)} 元
        </p>
      </div>
    </div>
  );
}
